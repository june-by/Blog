---
title: "SSG ì—ëŸ¬ í•¸ë“¤ë§(useQuery, on Error, try-catch)"
date: "2023-06-09"
lastmod: "2023-06-09"
category: "TroubleShooting"
tags: ["react-query", "ssg"]
description: "SSGí˜•íƒœë¡œ ë Œë”ë§í•˜ëŠ” ë¸”ë¡œê·¸ ê° í¬ìŠ¤íŠ¸ í˜ì´ì§€ì— ëŒ€í•´ queryStringì´ ë¹„ì •ìƒì ì¸ ê²½ìš°ì— ëŒ€í•œ ì—ëŸ¬í•¸ë“¤ë§ì„ ë‹¤ë£¬ í¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤."
thumbNail: "https://github.com/BY-juun/Blog/assets/78716842/1a162e61-7b6f-455c-98c4-e9bf0bf92bc7"
---

# ğŸŒ„ ë°°ê²½

ê²Œì‹œê¸€ í˜ì´ì§€(`/page/:postId`)ì—ì„œëŠ” ë¹Œë“œíƒ€ì„ì—Â `HTML`ê³¼Â `JSON`ì„ ë§Œë“¤ì–´ ë†“ì•˜ìŠµë‹ˆë‹¤. ([ë¸”ë¡œê·¸ ê²Œì‹œê¸€ í˜ì´ì§€ SSR â†’ SSG ì „í™˜ê¸°](https://byjuun.com/posts/React/blog-ssr-to-ssg))

ê·¸ë¦¬ê³  ë¹Œë“œíƒ€ì„ì— ìƒì„±í•´ë†“ì§€ ì•Šì€Â `path`ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¨ ê²½ìš°,Â `fallback : true`Â ì˜µì…˜ì„ í†µí•´,Â `getStaticProps`ì˜ ë™ì‘ì„ ì•„ë˜ì™€ ê°™ì´ ë³€ê²½í•©ë‹ˆë‹¤.

1. ìƒì„±í•´ ë†“ì§€ ì•Šì€Â `path`ì— ëŒ€í•´ì„œëŠ”Â `404`ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šê³  í˜ì´ì§€ì˜Â `Fallback`Â ë²„ì „ì„ ë³´ì—¬ì¤€ë‹¤.
2. ë°±ê·¸ë¼ìš´ë“œì—ì„œÂ `NextJS`ê°€ ìš”ì²­ëœÂ `path`ì— ëŒ€í•´ì„œÂ `getStaticProps`Â í•¨ìˆ˜ë¥¼ ì´ìš©í•´,Â `HTML`íŒŒì¼ê³¼Â `JSON`íŒŒì¼ì„ ë§Œë“ ë‹¤.
3. ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ê¸° ëë‚˜ë©´, ìš”ì²­ëœÂ `path`ì— í•´ë‹¹í•˜ëŠ”Â `JSON`íŒŒì¼ì„ ë°›ì•„ì„œ ìƒˆë¡­ê²Œ í˜ì´ì§€ë¥¼ ë Œë”ë§í•œë‹¤.
4. ì‚¬ìš©ìëŠ”Â `Fallback`Â ë²„ì „ â†’ ì™„ì„±ëœ í˜ì´ì§€ ìˆœì„œë¡œ í™”ë©´ì„ ë³´ê²Œ ëœë‹¤.

```tsx title="pages/post.tsx"
const Post = () => {
  const router = useRouter();
  const { data } = useGetOnePost(Number(router.query.id));
  //Prefetchí•œ Queryë¥¼ ë°˜í™˜í•˜ëŠ” ì»¤ìŠ¤í…€ í›…
  if (router.isFallback) return <PostSkeleton />;
  // ë¹Œë“œíƒ€ì„ì— ìƒì„±í•´ë†“ì§€ ì•ŠëŠ” pathë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš° isFallback : true
  return <>...</>;
};

export const getStaticPaths = async () => {
  try {
    const data = await getAllPostsId();
    const paths = data.map(({ id }) => {
      return { params: { id: String(id) } };
    });
    return {
      paths,
      fallback: true, // fallback option setting
    };
  } catch (err) {
    return {
      paths: [],
      fallback: true,
    };
  }
};

export const getStaticProps: GetStaticProps = async (
  context: GetStaticPropsContext
) => {
  const queryClient = new QueryClient();
  await queryClient.fetchQuery(
    [QUERY_KEY.POST.ONE, Number(context.params?.id)],
    () => getOnePostAPI(Number(context.params?.id))
  );
  return {
    props: {
      dehydratedState: dehydrate(queryClient),
    },
  };
};
```

<br />

# âŒ ë¬¸ì œ ìƒí™©

ë¬¸ì œëŠ” ì‚¬ìš©ìê°€ ë¹„ì •ìƒì ì¸Â `id`ë¥¼ ì…ë ¥í•´ ì ‘ê·¼í•˜ëŠ” ê²½ìš°ì— ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ex,Â `/post/rke`,Â `/post/12544`Â â†’ ì—†ëŠ” ê²Œì‹œê¸€)

ì´ëŸ° ìƒí™©ì—ì„œëŠ” ì‚¬ìš©ìì—ê²Œ ì–´ë–¤ ìƒí™©ì¸ì§€ì— ëŒ€í•œÂ `alert`ë¥¼ ë³´ì—¬ì¤€ í›„, ë©”ì¸í˜ì´ì§€ë¡œÂ `redirect`Â ì‹œì¼œì•¼ í–ˆìŠµë‹ˆë‹¤.

ì´ ê³¼ì •ì—ì„œÂ `API`ë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ê°€Â `getStaticProps`Â í•¨ìˆ˜ì—ì„œ í˜¸ì¶œë˜ì–´ ì—ëŸ¬ ì²˜ë¦¬ì™€ ê´€ë ¨í•´ ë§ì€ ì‚½ì§ˆì„ í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤â€¦

<br />

# ğŸ¤” ì‚½ì§ˆ - ì™œ useQueryì˜ onErrorê°€ í˜¸ì¶œë˜ì§€ ì•Šì„ê¹Œ?

ë¶„ëª…,Â `API`Â ì½œì„ í•˜ëŠ” í•¨ìˆ˜ì—ì„œÂ `try catch`ë¥¼ í†µí•´, ì—ëŸ¬ë¥¼ í•¸ë“¤ë§í•˜ê³  í•´ë‹¹ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ”Â `useQuery`ì—ì„œÂ `onError`Â ì½œë°±ì„ ì§€ì •í•´ë‘ì—ˆì§€ë§Œ, í˜¸ì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

```tsx {22-26}
export const getOnePostAPI = async (id: number): Promise<PostType | null> => {
  if (isNaN(id)) throw new Error(MESSAGE.INVALIDE_ACCESS);
  if (!id) throw new Error();
  try {
    const { data } = await customAxios.get(`/post/load/${id}`);
    return data;
  } catch (err: any) {
    console.log("throw Error");
    throw Error(err?.response?.data);
  }
};

export const useGetOnePost = (id: number) => {
  const router = useRouter();

  return useQuery<PostType | null>(
    [QUERY_KEY.POST.ONE, id],
    () => getOnePostAPI(id),
    {
      ...CACHE_OPTION.ALL,
      enabled: isNaN(id) ? false : true,
      onError: (err) => {
        console.log("useGetOnePost onError Called");
        alert(err);
        router.replace("/");
      },
    }
  );
};
```

ê´€ë ¨ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì°¾ì•„ë³´ë‹ˆ,Â `useQuery`Â ì¸ìë¡œ ë„£ì–´ì£¼ëŠ”Â `API`Â í˜¸ì¶œ í•¨ìˆ˜ì—ì„œÂ `try catch`ë¥¼ í†µí•´ ì—ëŸ¬ í•¸ë“¤ë§ì„ í•  ê²½ìš°,Â `useQuery`ì˜Â `onError`Â ì½œë°±ì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ,Â `useQuery`ì˜Â `onSuccess`Â ì½œë°±ì´ ì‹¤í–‰ëœë‹¤ëŠ” ë‚´ìš©ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

- [https://velog.io/@bunny/react-query-onError-ê°€-ì¡í•˜ì§€-ì•Šì„ë•Œ](https://velog.io/@bunny/react-query-onError-%EA%B0%80-%EC%9E%A1%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%84%EB%95%8C)

- [https://11001.tistory.com/205](https://11001.tistory.com/205)

<br />

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, ì´ 3ê°€ì§€ ë°©ë²•ì„ ì‚¬ìš©í–ˆì§€ë§Œ ëª¨ë‘ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

1. API í˜¸ì¶œ í•¨ìˆ˜ì—ì„œ try catch ì§€ìš°ê¸°
2. onSuccessë¥¼ ì´ìš©í•œ ì—ëŸ¬ í•¸ë“¤ë§
3. ì»¤ìŠ¤í…€í›… ë‚´ë¶€ì—ì„œ ì¿¼ë¦¬ ë°˜í™˜ê°’ê³¼ useEffectë¥¼ í†µí•œ í•¸ë“¤ë§

ê·¸ë˜ì„œ,Â `onSuccess`Â ì½œë°±ì„ ë„£ê¸°ë„ í•´ë³´ê³ ,Â `try catchë¥¼`Â ì§€ì›Œë„ ë³´ì•˜ì§€ë§Œâ€¦ ì—¬ì „íˆ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

<img src="https://github.com/BY-juun/Blog/assets/78716842/2370dbee-47f9-42d0-bc2e-b6706813140e" />

```tsx title="1. try-catch ì§€ìš°ê¸°"
export const getOnePostAPI = async (id: number): Promise<PostType | null> => {
  if (isNaN(id)) throw new Error(MESSAGE.INVALIDE_ACCESS);
  if (!id) throw new Error();
  const { data } = await customAxios.get(`/post/load/${id}`);
  return data;
};
```

```tsx title="2. onSuccessë¡œ í•¸ë“¤ë§ (try-catchëŠ” ê·¸ëŒ€ë¡œ)"
export const useGetOnePost = (
  id: number,
  queryOptions?: UseQueryOptions<any>
) => {
  const router = useRouter();

  return useQuery<PostType | null>(
    [QUERY_KEY.POST.ONE, id],
    () => getOnePostAPI(id),
    {
      ...CACHE_OPTION.ALL,
      onSuccess: (data) => {
        if (data.error) {
          console.log("useGetOnePost onError Called");
          alert(data.error);
          router.replace("/");
        }
      },
      ...queryOptions,
    }
  );
};
```

```tsx title="3. Queryê²°ê³¼ì™€ useEffectë¥¼ ì´ìš©í•œ í•¸ë“¤ë§"
export const useGetOnePost = (id: number) => {
  const router = useRouter();

  const queryResult = useQuery<PostType | null>(
    [QUERY_KEY.POST.ONE, id],
    () => getOnePostAPI(id),
    {
      ...CACHE_OPTION.ALL,
    }
  );

  useEffect(() => {
    if (queryResult.isError) {
      alert(queryResult.error);
      router.replace("/");
    }
  }, [queryResult]);

  return queryResult;
};
```

<br />

# ğŸ›  í•´ê²°

ì´ì „ê¹Œì§€ ë¬¸ì œë¥¼ í•´ê²°í•˜ì§€ ëª»í–ˆë˜ ì´ìœ ëŠ” ë¹Œë“œíƒ€ì„ì— ìƒì„±í•´ë†“ì§€ ì•Šì€Â `path`ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¨ ê²½ìš°,Â `getStaticProps`Â ë‚´ë¶€ ë¡œì§ì´ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤ê³  ìƒê°í–ˆê¸° ë•Œë¬¸ì´ì—ˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ,Â `Hook`ê³¼Â `API`Â í˜¸ì¶œ í•¨ìˆ˜ì—ì„œ ì–´ë–¤ ë°©ë²•ì„ ì¨ë„ ì—ëŸ¬ ë©”ì‹œì§€ì— ë‚˜ì˜¨ê²ƒì²˜ëŸ¼Â `static props`ë¥¼Â `load`í•˜ëŠ” ê³¼ì •ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí–ˆë˜ ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.

ìµœì¢…ì ìœ¼ë¡œ,Â `getStaticProps`Â ë‚´ë¶€ì—ì„œÂ `API`ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì„Â `try-catch`ë¡œ ê°ì‹¸ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

```tsx
export const getStaticProps: GetStaticProps = async (
  context: GetStaticPropsContext
) => {
  const queryClient = new QueryClient();
  try {
    await queryClient.fetchQuery(
      [QUERY_KEY.POST.ONE, Number(context.params?.id)],
      () => getOnePostAPI(Number(context.params?.id))
    );
    return {
      props: {
        dehydratedState: dehydrate(queryClient),
      },
    };
  } catch (err) {
    console.log("getStaticProps catch called");
    return { props: {} };
  }
};
```

`getStaticProps`Â ë‚´ë¶€ì—ì„œÂ `try-catch`ë¥¼ í†µí•´ ì—ëŸ¬ í•¸ë“¤ë§ í•´ì£¼ë‹ˆ, ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ê³ , ì œê°€ ì˜ë„í•œëŒ€ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë Œë”ë§í•˜ëŠ” ë‹¨ê³„ê¹Œì§€ ë„˜ì–´ì˜¤ê²Œ ë˜ì—ˆê³ ,Â `onError`ì½œë°±ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.
